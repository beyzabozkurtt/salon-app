<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Adisyon DetayÄ±</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4 bg-light">

  <div class="container">
    <h4 class="mb-3">Adisyon DetayÄ±</h4>

    <div class="card p-4 shadow-sm">
      <h5 id="customerName" class="text-primary fw-bold">MÃ¼ÅŸteri</h5>

      <div class="row mt-3">
        <div class="col-md-6">
          <label class="form-label">Zaman</label>
          <input type="date" id="appointmentDate" class="form-control" />
        </div>
        <div class="col-md-6">
          <label class="form-label text-white">.</label>
          <div class="input-group">
            <input type="number" id="appointmentHour" class="form-control" placeholder="Saat" min="0" max="23">
            <input type="number" id="appointmentMinute" class="form-control" placeholder="Dakika" min="0" max="59">
          </div>
        </div>
      </div>

      <div class="mt-3">
        <label class="form-label">Durum</label>
        <div class="btn-group" role="group" id="statusGroup">
          <button type="button" class="btn btn-outline-secondary" data-status="bekliyor">BelirtilmemiÅŸ</button>
          <button type="button" class="btn btn-outline-success" data-status="tamamlandÄ±">Geldi</button>
          <button type="button" class="btn btn-outline-danger" data-status="iptal">iptal</button>
        </div>
      </div>
    </div>
  </div>
  <div class="mt-4 text-end">
  <button class="btn btn-success" id="saveBtn">ğŸ’¾ DeÄŸiÅŸiklikleri Kaydet</button>
</div>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
 <script>
  const token = localStorage.getItem("companyToken");
  const config = {
    headers: { Authorization: "Bearer " + token }
  };

  const urlParams = new URLSearchParams(window.location.search);
  const appointmentId = urlParams.get("id");
  let currentStatus = "";

  async function loadAppointment() {
    try {
      const res = await axios.get(`http://localhost:5001/api/appointments/${appointmentId}`, config);
      const data = res.data;

      document.getElementById("customerName").textContent = data.Customer.name;

      const dateObj = new Date(data.date);
      document.getElementById("appointmentDate").value = dateObj.toISOString().split("T")[0];
      document.getElementById("appointmentHour").value = dateObj.getHours();
      document.getElementById("appointmentMinute").value = dateObj.getMinutes();

      currentStatus = data.status;
      document.querySelectorAll("#statusGroup button").forEach(btn => {
        if (btn.dataset.status === currentStatus) btn.classList.add("active");

        btn.addEventListener("click", () => {
          document.querySelectorAll("#statusGroup button").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          currentStatus = btn.dataset.status;
        });
      });
    } catch (err) {
      alert("Detay verisi alÄ±namadÄ±.");
      console.error(err);
    }
  }

  // âœ… PUT iÅŸlemi: Kaydet Butonu
  document.getElementById("saveBtn").addEventListener("click", async () => {
    const selectedDate = document.getElementById("appointmentDate").value;
    const hour = document.getElementById("appointmentHour").value.padStart(2, '0');
    const minute = document.getElementById("appointmentMinute").value.padStart(2, '0');

    const fullDateTime = `${selectedDate}T${hour}:${minute}:00`;

    try {
      await axios.put(`http://localhost:5001/api/appointments/${appointmentId}`, {
        date: fullDateTime,
        status: currentStatus
      }, config);

      alert("âœ… GÃ¼ncelleme baÅŸarÄ±lÄ±!");
    } catch (err) {
      console.error("âŒ GÃ¼ncelleme hatasÄ±:", err);
      alert("âŒ Kaydetme baÅŸarÄ±sÄ±z.");
    }
  });

  loadAppointment();
</script>

</body>
</html>
