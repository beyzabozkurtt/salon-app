<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Adisyon Detayı</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4 bg-light">
  <div class="container">
    <h4 class="mb-3">Adisyon Detayı</h4>

    <div class="card p-4 shadow-sm mb-4">
      <h5 id="customerName" class="text-primary fw-bold">Müşteri</h5>

      <div class="row mt-3">
        <div class="col-md-6">
          <label class="form-label">Zaman</label>
          <input type="date" id="appointmentDate" class="form-control" />
        </div>
        <div class="col-md-6">
          <label class="form-label text-white">.</label>
          <div class="input-group">
            <input type="number" id="appointmentHour" class="form-control" placeholder="Saat" min="0" max="23">
            <input type="number" id="appointmentMinute" class="form-control" placeholder="Dakika" min="0" max="59">
          </div>
        </div>
      </div>

      <div class="mt-3">
        <label class="form-label">Durum</label>
        <div class="btn-group" role="group" id="statusGroup">
          <button type="button" class="btn btn-outline-secondary" data-status="bekliyor">Belirtilmemiş</button>
          <button type="button" class="btn btn-outline-success" data-status="tamamlandı">Geldi</button>
          <button type="button" class="btn btn-outline-danger" data-status="iptal">İptal</button>
        </div>
      </div>
    </div>

    <!-- Yeni Bilgi Kutusu -->
    <div class="card p-4 shadow-sm">
      <div class="mb-2"><strong>Paket:</strong> <span id="packageName">-</span></div>
      <div class="mb-2"><strong>Seans:</strong> <span id="sessionInfo">-</span></div>

      <div class="mb-2">
        <label class="form-label">Personel</label>
        <select id="personelSelect" class="form-select"></select>
      </div>

      <div class="mb-2">
        <label class="form-label">Süre (dakika)</label>
        <input type="number" id="duration" class="form-control" />
      </div>
    </div>

    <div class="mt-4 text-end">
      <button class="btn btn-success" id="saveBtn">💾 Değişiklikleri Kaydet</button>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
const token = localStorage.getItem("companyToken");
const config = { headers: { Authorization: "Bearer " + token } };
const urlParams = new URLSearchParams(window.location.search);
const appointmentId = urlParams.get("id");
let currentStatus = "";

async function loadAppointment() {
  try {
    const res = await axios.get(`http://localhost:5001/api/appointments/${appointmentId}`, config);
    const data = res.data;

    document.getElementById("customerName").textContent = data.Customer?.name || "-";
    document.getElementById("packageName").textContent = data.serviceName || "-";
    document.getElementById("sessionInfo").textContent = `${data.sessionNumber || "-"}. seans`;
    document.getElementById("duration").value = data.duration || "";

    const dateObj = new Date(data.date);
    document.getElementById("appointmentDate").value = dateObj.toISOString().split("T")[0];
    document.getElementById("appointmentHour").value = dateObj.getHours();
    document.getElementById("appointmentMinute").value = dateObj.getMinutes();

    currentStatus = data.status;
    document.querySelectorAll("#statusGroup button").forEach(btn => {
      if (btn.dataset.status === currentStatus) btn.classList.add("active");

      btn.addEventListener("click", () => {
        document.querySelectorAll("#statusGroup button").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        currentStatus = btn.dataset.status;
      });
    });

    await loadUsers(data.UserId);
  } catch (err) {
    alert("Detay verisi alınamadı.");
    console.error(err);
  }
}

async function loadUsers(selectedId) {
  try {
    const res = await axios.get("http://localhost:5001/api/users", config);
    const select = document.getElementById("personelSelect");
    res.data.forEach(user => {
      const opt = document.createElement("option");
      opt.value = user.id;
      opt.textContent = user.name;
      if (user.id === selectedId) opt.selected = true;
      select.appendChild(opt);
    });
  } catch (err) {
    console.error("Kullanıcılar yüklenemedi:", err);
  }
}

document.getElementById("saveBtn").addEventListener("click", async () => {
  const selectedDate = document.getElementById("appointmentDate").value;
  const hour = document.getElementById("appointmentHour").value.padStart(2, '0');
  const minute = document.getElementById("appointmentMinute").value.padStart(2, '0');
  const fullDateTime = `${selectedDate}T${hour}:${minute}:00`;

  const duration = parseInt(document.getElementById("duration").value);
  const endDate = new Date(new Date(fullDateTime).getTime() + duration * 60000).toISOString();

  try {
    await axios.put(`http://localhost:5001/api/appointments/${appointmentId}`, {
      date: fullDateTime,
      endDate: endDate,
      status: currentStatus,
      UserId: document.getElementById("personelSelect").value
    }, config);

    alert("✅ Güncelleme başarılı!");
  } catch (err) {
    console.error("❌ Güncelleme hatası:", err);
    alert("❌ Kaydetme başarısız.");
  }
});

loadAppointment();
</script>
</body>

</html>
